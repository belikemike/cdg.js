/*
 *  cdg.js - a CD+G player for the web, based upon CD+Graphics Magic HTML5 CD+G Player
 *  (http://cdgmagic.sourceforge.net/html5_cdgplayer/). Visit project for full license
 *  information and documentation: https://github.com/willprescott/cdg.js
 */

define("cdg",[],function(){"use strict";function e(e,r){function t(){H=0,A=0,f(),u(0),c()}function a(){return H}function o(){if((L||P)&&(p.style.backgroundColor=i(A),L=!1),P)s(),P=!1,c(),O.putImageData(m,0,0);else for(var e=O,r=m,t=S,a=C.FONT_WIDTH,o=C.FONT_HEIGHT,n=0,d=1;16>=d;++d){n=d*C.NUM_X_FONTS+1;for(var f=1;48>=f;++f)t[n]&&(l(f,d),e.putImageData(r,0,0,(f-1)*a,(d-1)*o,a,o),t[n]=0),++n}}function n(e,r){for(var t=H;r>t;t++){var a=24*t,o=63&e.charCodeAt(a);if(o==C.TV_GRAPHICS){var n=e.slice(a,a+24),i=63&n.charCodeAt(1);switch(i){case C.MEMORY_PRESET:T(n);break;case C.BORDER_PRESET:_(n);break;case C.LOAD_CLUT_LO:case C.LOAD_CLUT_HI:E(n);break;case C.COPY_FONT:case C.XOR_FONT:h(n);break;case C.SCROLL_PRESET:case C.SCROLL_COPY:F(n)}}}H=r}function i(e){return"rgb("+(g[e]>>16&255)+","+(g[e]>>8&255)+","+(g[e]>>0&255)+")"}function d(e){var r=e;return r|=e<<4,r|=e<<8,r|=e<<12,r|=e<<16,r|=e<<20}function c(){for(var e=0;900>e;e++)S[e]=0}function f(){for(var e=C.PALETTE_ENTRIES,r=0;e>r;r++)g[r]=0}function u(e){for(var r=N,t=r.length,a=d(e),o=0;t>o;o++)r[o]=a;P=!0}function s(){for(var e=m.data,r=g,t=N,a=48,o=C.VISIBLE_HEIGHT,n=601,i=0,d=0,c=0,f=0;o>f;++f){for(var u=0;a>u;++u)c=t[n++],d=r[c>>0&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255,d=r[c>>4&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255,d=r[c>>8&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255,d=r[c>>12&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255,d=r[c>>16&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255,d=r[c>>20&15],e[i++]=d>>16&255,e[i++]=d>>8&255,e[i++]=d>>0&255,e[i++]=255;n+=2}}function l(e,r){var t=m.data,a=g,o=N,n=r*C.NUM_X_FONTS*C.FONT_HEIGHT+e,i=C.NUM_X_FONTS,d=n+C.NUM_X_FONTS*C.FONT_HEIGHT,c=(r-1)*C.FONT_HEIGHT*C.VISIBLE_WIDTH;c+=(e-1)*C.FONT_WIDTH,c*=4;for(var f=4*(C.VISIBLE_WIDTH-C.FONT_WIDTH),u=0,s=0;d>n;)s=o[n],u=a[s>>0&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>4&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>8&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>12&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>16&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>20&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,n+=i,c+=f}function _(e){var r=63&e.charCodeAt(4);g[r]!=g[A]&&(L=!0),A=r}function T(e){u(63&e.charCodeAt(4))}function E(e){for(var r=g,t=8*(1&e.charCodeAt(1)),a=0;8>a;a++){var o=a+t,n=0,i=0;i=(60&e.charCodeAt(2*a+4))>>2,n|=17*i<<16,i=(3&e.charCodeAt(2*a+4))<<2|(48&e.charCodeAt(2*a+5))>>4,n|=17*i<<8,i=15&e.charCodeAt(2*a+5),n|=17*i<<0,n!=r[o]&&(r[o]=n,P=!0,o==A&&(L=!0))}}function h(e){var r=N,t=S,a=3,o=(48&e.charCodeAt(4))>>2|(48&e.charCodeAt(5))>>4,n=32&e.charCodeAt(1);if(a>>o){var i=63&e.charCodeAt(7),d=31&e.charCodeAt(6);if(49>=i&&17>=d){for(var c=600*d+i,f=[15&e.charCodeAt(4),15&e.charCodeAt(5)],u=0,s=0,l=0;12>l;l++){var _=50*l+c;u=e.charCodeAt(l+8),s=f[u>>5&1]<<0,s|=f[u>>4&1]<<4,s|=f[u>>3&1]<<8,s|=f[u>>2&1]<<12,s|=f[u>>1&1]<<16,s|=f[u>>0&1]<<20,n?r[_]^=s:r[_]=s}t[50*d+i]=1}}}function F(e){var r,t=(8&e.charCodeAt(1))>>3,a=15&e.charCodeAt(4);(r=(48&e.charCodeAt(5))>>4)&&v(r,t,a),(r=(48&e.charCodeAt(6))>>4)&&I(r,t,a),P=!0}function v(e,r,t){var a,o,n,i=0,c=d(t),f=N;if(2==e)for(o=0;10800>o;o+=50){for(n=o,i=f[n],a=n+1;n+50>a;a++)f[a-1]=f[a];r?f[n+49]=i:f[n+49]=c}else if(1==e)for(o=0;10800>o;o+=50){for(n=o,i=f[n+49],a=n+48;a>=n;a--)f[a+1]=f[a];r?f[n]=i:f[n]=c}}function I(e,r,t){var a,o,n=C.NUM_X_FONTS*C.FONT_HEIGHT,i=new Array(n),c=d(t),f=N;if(2==e){for(a=0,o=0;n>o;o++)i[a++]=f[o];for(a=0,o=n;10800>o;o++)f[a++]=f[o];if(a=204*C.NUM_X_FONTS,r)for(o=0;n>o;o++)f[a++]=i[o];else for(o=0;n>o;o++)f[a++]=c}else if(1==e){for(a=0,o=10200;10800>o;o++)i[a++]=f[o];for(o=10199;o>0;o--)f[o+n]=f[o];if(r)for(o=0;n>o;o++)f[o]=i[o];else for(o=0;n>o;o++)f[o]=c}}var C={VRAM_HEIGHT:216,VISIBLE_WIDTH:288,VISIBLE_HEIGHT:192,FONT_WIDTH:6,FONT_HEIGHT:12,NUM_X_FONTS:50,NUM_Y_FONTS:18,PALETTE_ENTRIES:16,TV_GRAPHICS:9,MEMORY_PRESET:1,BORDER_PRESET:2,LOAD_CLUT_LO:30,LOAD_CLUT_HI:31,COPY_FONT:6,XOR_FONT:38,SCROLL_PRESET:20,SCROLL_COPY:24},p=r,O=e.getContext("2d"),m=O.createImageData(C.VISIBLE_WIDTH,C.VISIBLE_HEIGHT),g=new Array(C.PALETTE_ENTRIES),N=new Array(C.NUM_X_FONTS*C.VRAM_HEIGHT),A=0,H=0,L=!1,P=!1,S=new Array(900);this.get_current_pack=a,this.reset_cdg_state=t,this.redraw_canvas=o,this.decode_packs=n,this.reset_cdg_state()}function r(r,t){function a(){if(I&&4==I.readyState){if(200!=I.status)throw new Error("CDG file failed to load");C=I.responseText,I=null}}function o(){if(h.error){var e=h.error.code?h.error.code:h.error;throw new Error("The audio control fired an error event. Could be: "+e)}}function n(){if(null!=C){var e,r=Math.floor(300*h.currentTime),t=p.get_current_pack();r=0>r?0:r,t-300>r&&(p.reset_cdg_state(),t=0),e=t+6,e=r>e?r:e,e>t&&(p.decode_packs(C,e),p.redraw_canvas())}}function i(){v=setInterval(n,20)}function d(){clearInterval(v)}function c(){h.play()}function f(){h.pause()}function u(){h.pause(),h.currentTime=0}function s(e){if(!e||Array.isArray(e)||"string"!=typeof e&&"object"!=typeof e)throw new Error("No track information specified, nothing to load!");var r,t,a=T.mediaPath,o=T.audioFormat,n=T.cdgFileExtension;if("object"==typeof e){if(!e.audioFilePrefix)throw new Error("No audioFilePrefix property defined, nothing to load!");if(r=e.audioFilePrefix,t=e.cdgFilePrefix?e.cdgFilePrefix:e.audioFilePrefix,e.mediaPath&&(a=e.mediaPath),e.audioFormat){if(!E[e.audioFormat])throw new Error("Unsupported audio format specified");o=e.audioFormat}e.cdgFileExtension&&(n=e.cdgFileExtension)}else r=t=e;return{audioFilePrefix:r,cdgFilePrefix:t,mediaPath:a,audioFormat:o,cdgFileExtension:n}}function l(e){var r=s(e);return d(),p.reset_cdg_state(),p.redraw_canvas(),C=null,I=new XMLHttpRequest,I.onreadystatechange=a,I.open("GET",r.mediaPath+r.cdgFilePrefix+"."+r.cdgFileExtension,!0),I.setRequestHeader("Content-Type","text/html"),I.send(),null==F&&(F=document.createElement("source")),F.type=E[r.audioFormat],F.src=r.mediaPath+r.audioFilePrefix+"."+r.audioFormat,h.appendChild(F),h.load(),this}function _(r,t){if(!r)throw new Error("Required initialisation parameter missing.");var a=document.getElementById(r),n=document.createElement("div"),c=document.createElement("canvas");h=document.createElement("audio"),n.id=r+"-border",n.className="cdg-border",c.id=r+"-canvas",c.width="288",c.height="192",c.className="cdg-canvas",h.id=r+"-audio",h.className="cdg-audio",n.appendChild(c),a.appendChild(n),a.appendChild(h),h.style.width=c.offsetWidth+"px",h.controls=!(t&&0==t.showControls),h.autoplay=!(t&&0==t.autoplay),h.addEventListener("error",o,!0),h.addEventListener("play",i,!0),h.addEventListener("pause",d,!0),h.addEventListener("ended",d,!0),h.addEventListener("abort",d,!0),p=new e(c,n)}var T={mediaPath:"",audioFormat:"mp3",cdgFileExtension:"cdg"},E={mp3:'audio/mpeg; codecs="mp3"',ogg:'audio/ogg; codecs="vorbis"'},h=null,F=null,v=null,I=null,C=null,p=null;_(r,t),this.loadTrack=l,this.play=c,this.stop=u,this.pause=f}return{init:function(e,t){return new r(e,t)}}}),define("cdg.js",function(){});
//# sourceMappingURL=cdg.js.build.js.map
//# sourceMappingURL=cdg.js.map
